import type { NextFunction, Request, Response } from "express";
import { supabase } from "./lib/supabase.ts";

export const protectedRoute = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const authorization = req.headers.authorization.split(" ")[1]; // Extract token from "Bearer <token>"
  if (!authorization) {
    return res.status(401).json({
      ok: false,
      message: "No se proporcion칩 el token de autorizaci칩n",
    });
  }

  /** Verificar token con supabase */
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser(authorization);

  if (error || !user) {
    return res.status(401).json({
      ok: false,
      message: "Token de autorizaci칩n inv치lido",
    });
  }

  req.user = user; // Incrustar en la request el usuario autenticado para las demas rutas
  next();
};
